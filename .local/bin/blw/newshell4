#!/bin/bash

# Path to the image you want to display
IMAGE_PATH="/home/euler/Pictures/Wallpapers/pawel-czerwinski-3kvvTckVHhs-unsplash.jpg"
THUMBNAIL_PATH="${IMAGE_PATH%.*}-thumbnail.${IMAGE_PATH##*.}"

# Colors
ORANGE="\e[37m"
BLUE="\e[0m"
GREEN="\e[31m"
STOP="\e[0m"

# Fixed image dimensions
FIXED_WIDTH=127
FIXED_HEIGHT=127

# Get terminal size
get_window_size() {
    echo "Getting terminal size..."
    if [[ -z $VTE_VERSION ]]; then
        case ${TMUX:-null} in
            "null") printf '%b' '\e[14t' ;;
            *)      printf '%b' '\ePtmux;\e\e[14t\e\\ ' ;;
        esac
    fi

    # Read terminal size with a timeout
    IFS=';t' read -d t -t 0.05 -sra term_size
    unset IFS

    term_height="${term_size[1]}"
    term_width="${term_size[2]}"

    echo "Terminal width: $term_width"
    echo "Terminal height: $term_height"
}

# Create a thumbnail of fixed size
create_thumbnail() {
    echo "Creating thumbnail..."
    convert "$IMAGE_PATH" -resize "${FIXED_WIDTH}x${FIXED_HEIGHT}^" -gravity center -crop "${FIXED_WIDTH}x${FIXED_HEIGHT}+0+0" +repage "$THUMBNAIL_PATH" || {
        echo "Failed to create thumbnail. Please check permissions and paths."
        exit 1
    }
}

# Display the image
display_image() {
    echo "Displaying image..."
    kitty +kitten icat --align left --scale-up --stdin no --transfer-mode stream --place "${FIXED_WIDTH}x${FIXED_HEIGHT}@0x0" "$THUMBNAIL_PATH"
}

# Display the text
display_text() {
    # Generate figlet text
    mapfile -t left < <(figlet -f standard "Buddhi")
    mapfile -t right < <(figlet -f standard "LW")

    # Calculate maximum line length
    maxlength=0
    for line in "${left[@]}"; do
        if (( ${#line} > maxlength )); then
            maxlength=${#line}
        fi
    done

    # Move cursor to the right of the image
    tput cup 0 $((FIXED_WIDTH + 1))

    # Print text next to the image
    printf "${GREEN}"
    printf "%*s\n" $((FIXED_WIDTH + maxlength + 2)) "==================================="

    for ((i = 0; i < ${#left[@]}; ++i)); do
        printf "${ORANGE}%*s ${GREEN}%s\n" $((maxlength)) "${left[i]}" "${right[i]}"
    done | sed "$ d" | sed "$ d"

    printf "${GREEN}"
    printf "%*s\n" $((FIXED_WIDTH + maxlength + 2)) "======================================="
    printf "${STOP}"

    # Position cursor for fortune output
    tput cup $((FIXED_HEIGHT + 6)) 0
    fortune | lolcat -t
}

# Main execution
get_window_size
create_thumbnail
display_image
display_text
